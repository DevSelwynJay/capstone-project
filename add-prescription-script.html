<script>


    let inv_id; /// id of vaccine or medicine

    function retrieve_inventory() {
        $.post('php/patientProcesses/retrieveInventory.php').done(function (data) {


            let obj = JSON.parse(data);
            let arr = []
            inventory_autocomlete(obj);
            for (const objElement of obj) {
                arr.push(objElement.name)
            }
            inventory_autocomlete(obj)
        })
    }
    retrieve_inventory()

    function inventory_autocomlete(obj) {
        function split( val ) {
            return val.split( / \s*/ );
        }
        function extractLast( term ) {
            return split( term ).pop();
        }

        $( "#search-inv" )
            // don't navigate away from the field on tab when selecting an item
            .on( "keydown", function( event ) {
                if ( event.keyCode === $.ui.keyCode.TAB &&
                    $( this ).autocomplete( "instance" ).menu.active ) {
                    event.preventDefault();
                }
            })
            .autocomplete({
                minLength: 0,
                source: function( request, response ) {
                    // delegate back to autocomplete, but extract the last term
                    response( $.ui.autocomplete.filter(
                       obj, extractLast( request.term ) ) );
                },
                classes: {
                    "ui-autocomplete": "highlight"
                },
                focus: function() {
                    // prevent value inserted on focus
                    return false;
                },
                select: function( event, ui ) {
                    var terms = split( this.value );
                    // remove the current input
                    terms.pop();
                    // add the selected item
                    terms.push( ui.item.value );
                    // add placeholder to get the comma-and-space at the end
                    terms.push( "" );
                    this.value = terms.join( " " );

                    $( "#search-inv" ).val(ui.item.label)
                    //user defined code
                    //alert(ui.item.id) //get the ID of selected item
                    inv_id = ui.item.id;
                    $("#inv-category-lbl").html(ui.item.category)//show label 'selected medicine/vaccine'
                    $("#inv-name").val(ui.item.label).trigger('focus')
                    $("#inv-type").val(ui.item.category)

                    $("#sub-category-lbl").html(ui.item.category)//show label 'medicine/vaccine category'
                    $("#sub-category").val(ui.item.subcategory)

                    //to change attribute of add prescription button weather it is add vaccination or medication
                    if(ui.item.category.toLowerCase()=="medicine"){
                        $(".prescript-btn-class").prop('id','add-prescript-btn')
                            console.log("med UI")
                        $("#add-med-UI-cont").css('display','block')
                        $("#add-vaccine-UI-cont").css('display','none')
                    }
                    else {
                        $(".prescript-btn-class").prop('id','add-vaccine-btn')
                        $("#add-med-UI-cont").css('display','none')
                        $("#add-vaccine-UI-cont").css('display','block')
                        console.log("vaccine UI")
                    }


                    $("#inv-name-and-qty-lbl").html(' <span id="inv-name-2">Medicine</span> currently has <span id="inv-stock-2">500</span> stocks.')
                    $("#inv-name-2").html(ui.item.label)
                    $("#inv-stock-2").html(ui.item.stock_count)

                    //$( "#search-inv" ).val("")
                    return false;
                }
            }).autocomplete( "instance" )._renderItem = function( ul, item ) {
            return $( "<li>" )
                .append(
                    "<div class='search-item' style='background: #F1F4FF;color:#232020'>"
                    + "<p class='modal-p' style='color: inherit'>"+ item.label+ "<span style='margin-right: 0.5rem'>("+item.dosage+")</span>"
                    + "<br>"+"<p style='color: inherit' class='modal-p-lighter flex-box-row justify-content-end'>x"+item.stock_count)
                .appendTo( ul );
        };

    }//end of function



        //ADD MEDICATION SCRIPT =========================
        $("#add-prescript-btn").click(function (event) {
            let medName = $("#med-name").val()
            let medSubCat = $("#sub-category").val()
            let qty = $("#qty").val()
            let freq = $("#frequency").val()
            let interval = $("#interval").val()
            let dosage = $("#dosage").val()
            let no_of_times = $("#no_of_times").val()//a day
            let description = $("#description").val()
            let start_date = $("#start-date").val()
            let end_date = $("#end-date").val()

            //validation of input
            if(medName==""||qty==""||dosage==""||no_of_times==""||description==""){
                $(".modal-p-error").css('visibility','visible')
                return
            }
            if (freq==1){
                if(interval==""||interval==null){
                    $(".modal-p-error").css('visibility','visible')
                    $("#interval").trigger('focus')
                    return;
                }
            }

            //makakadaan  lang dine pag ok na lhat ng input
            $("#pop-up-confirm-add").modal({
                showClose:false,
                closeExisting:false,
                clickClose:false,
                escapeClose:false
            })
            $("#prescribe-final-btn").off('click')
            $("#prescribe-final-btn").click(function () {
                $(".modal-p-error").css('visibility','hidden')
                if(freq==0){// 0 daily, 1 every other day
                    interval=0;
                }
                if(end_date==""||end_date==null){
                    end_date=null
                }
                $.post('php/patientProcesses/addMedicationRecord.php',{
                    inv_id:inv_id,
                    medName:medName,
                    medSubCat: medSubCat,
                    qty:qty,
                    interval:interval,
                    dosage:dosage,
                    no_of_times:no_of_times,
                    description:description,
                    start_date:start_date,
                    end_date:end_date,
                }).done(function (data) {
                    console.log(data)
                    retrieve_inventory();//refresh the inventory na lumalabas sa search bar
                    $("#hidden-refresh-button").trigger('click')
                    $('[href="#pop-up-confirm-add"]').trigger('click')//close modal
                    $('[href="#add-pres-modal"]').trigger('click')
                    reset_add_prescription_form()
                })
            })


        })//end of add prescription btn function

        function reset_add_prescription_form() {
            $("#med-name").val("")
            $("#sub-category").val("")
            $("#qty").val("")
            $("#frequency").val("0")
            $("#dosage").val("")
            $("#no_of_times").val("")//a day
            $("#description").val("")
            $("#start-date").val()
            $("#end-date").val("")
            $("#med-name-and-qty-lbl").html("Nothing is selected")
        }


</script>
<style>
    .search-item{
        padding-top: 0.6rem !important;
        font-family: 'Poppins', sans-serif;
        font-size: large;
    }
    .search-item p{
        font-family: inherit;
        font-size: inherit;
    }
    .ui-autocomplete {
        max-height: 50vh;
        overflow-y: auto;
        /* prevent horizontal scrollbar */
        overflow-x: hidden;
    }
    .ui-menu-item .ui-menu-item-wrapper.ui-state-active {/*highlight color ng aito complete text*/
        background: #d1d4dc !important;
        font-weight: bold !important;
        /*color: #ffffff !important;*/
        border: none !important;

    }
    ul,ol,li{
        /*border: none !important;*/
    }
    li{
        border-radius: 1rem;
    }

</style>